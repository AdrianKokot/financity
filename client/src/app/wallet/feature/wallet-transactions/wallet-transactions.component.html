<ng-container *tuiLet="dialogs$ | async">
  <ng-container *tuiLet="wallet$ | async as wallet">
    <main *tuiLet="data.items$ | async as items">
      <div class="w-full d-flex gap-4 mb-4">
        <label class="w-full">
          <tui-input
            [formControl]="filters.controls.search"
            [tuiTextfieldLabelOutside]="true"
            class="no-shadow"
            tuiTextfieldSize="s">
            Search
            <input tuiTextfield type="text" />
          </tui-input>
        </label>

        <label class="ml-auto" style="width: 250px">
          <tui-input-date-range
            [formControl]="filters.controls.transactionDate"
            [items]="dayRangeItems"
            [tuiTextfieldCleaner]="true"
            [tuiTextfieldLabelOutside]="true"
            class="no-shadow"
            tuiTextfieldSize="s">
            Date range
          </tui-input-date-range>
        </label>

        <ng-container
          *tuiLet="(filters.filtersCount$ | async) ?? 0 as filtersCount">
          <button
            (click)="filters.reset()"
            appearance="flat-outline"
            icon="tuiIconFilter"
            size="s"
            class="applied-filters-button"
            title="Reset filters to default"
            tuiIconButton
            type="button">
            <tui-badge
              *ngIf="filtersCount > 0"
              [value]="filtersCount"
              size="xs"
              status="primary"></tui-badge>
          </button>
        </ng-container>

        <button
          (click)="create$.next(undefined)"
          appearance="primary"
          size="s"
          tuiButton
          type="button">
          New transaction
        </button>
      </div>

      <div
        class="bg-base table-container border-radius-l border-base-3 border-width-s overflow-hidden">
        <tui-scrollbar>
          <cdk-virtual-scroll-viewport
            #viewport
            appInfiniteVirtualScroll
            (pageChange)="data.page($event)"
            [itemSize]="44"
            [fixed]="15.5"
            class="tui-zero-scrollbar"
            tuiScrollable>
            <table
              [columns]="[
                'transactionDate',
                'category',
                'labels',
                'note',
                'recipient',
                'amount',
                'actions'
              ]"
              class="w-full"
              tuiTable>
              <thead
                style="position: sticky; left: 0; z-index: 30"
                [style.top.px]="-viewport['_renderedContentOffset']">
                <tr tuiThGroup>
                  <th
                    *tuiHead="'transactionDate'"
                    tuiTh
                    [sorter]="null"
                    class="column-date">
                    Date
                  </th>
                  <th
                    *tuiHead="'category'"
                    tuiTh
                    [sorter]="null"
                    class="column-category">
                    <tui-hosted-dropdown [content]="categoriesDropdown">
                      <span
                        [class.text-link]="
                          filters.controls.categories.value.length > 0
                        "
                        class="column-filter-text">
                        <span>Category</span>

                        <tui-svg src="tuiIconSortDown"></tui-svg>
                      </span>
                    </tui-hosted-dropdown>
                  </th>
                  <th
                    *tuiHead="'labels'"
                    tuiTh
                    [sorter]="null"
                    class="column-labels">
                    <tui-hosted-dropdown [content]="labelsDropdown">
                      <span
                        [class.text-link]="
                          filters.controls.labels.value.length > 0
                        "
                        class="column-filter-text">
                        <span>Labels</span>

                        <tui-svg src="tuiIconSortDown"></tui-svg>
                      </span>
                    </tui-hosted-dropdown>
                  </th>
                  <th
                    *tuiHead="'note'"
                    tuiTh
                    [sorter]="null"
                    class="column-note">
                    Note
                  </th>
                  <th
                    *tuiHead="'recipient'"
                    [sorter]="null"
                    class="column-note"
                    tuiTh>
                    <tui-hosted-dropdown [content]="recipientsDropdown">
                      <span
                        [class.text-link]="
                          filters.controls.recipients.value.length > 0
                        "
                        class="column-filter-text">
                        <span>Recipient</span>

                        <tui-svg src="tuiIconSortDown"></tui-svg>
                      </span>
                    </tui-hosted-dropdown>
                  </th>
                  <th
                    *tuiHead="'amount'"
                    tuiTh
                    [sorter]="null"
                    class="column-amount">
                    Amount
                  </th>
                  <th
                    *tuiHead="'actions'"
                    tuiTh
                    [sorter]="null"
                    class="column-actions"></th>
                </tr>
              </thead>

              <tbody tuiTbody>
                <tr
                  *cdkVirtualFor="let item of items ?? []; trackBy: trackByIdx"
                  tuiTr>
                  <td *tuiCell="'transactionDate'" tuiTd>
                    {{ item.transactionDate | date : 'dd/MM/yyyy' }}
                  </td>
                  <td *tuiCell="'category'" tuiTd>
                    <span
                      *ngIf="item.category !== null"
                      class="d-flex align-items-center">
                      <tui-marker-icon
                        size="xs"
                        [attr.data-appearance-color]="
                          item.category.appearance.color ?? ''
                        "
                        [src]="
                          item.category.appearance.iconName ?? 'fa::question'
                        "></tui-marker-icon>
                      <span class="ml-2">
                        {{ item.category.name ?? '-' }}
                      </span>
                    </span>
                  </td>
                  <td *tuiCell="'labels'" tuiTd>
                    <tui-badge
                      *ngFor="let label of item.labels"
                      class="mr-1 bg-base-6"
                      [style.background-color]="
                        label.appearance.color
                          ? 'var(--' + label.appearance.color + ')'
                          : null
                      "
                      status="custom"
                      [value]="label.name"></tui-badge>
                  </td>
                  <td *tuiCell="'note'" tuiTd>
                    {{ (item.note ?? '').length > 0 ? item.note : '-' }}
                  </td>
                  <td *tuiCell="'recipient'" tuiTd>
                    {{ item.recipientName ?? '-' }}
                  </td>

                  <td *tuiCell="'amount'" tuiTd>
                    <tui-money
                      [currency]="item.currencyId"
                      [colored]="true"
                      [value]="
                        item.amount *
                        (item.transactionType === 'Expense' ? -1 : 1)
                      "></tui-money>

                    <ng-container
                      *ngIf="wallet && item.currencyId !== wallet.currencyId">
                      <span class="ml-2">(</span>
                      <tui-money
                        [colored]="false"
                        [currency]="wallet.currencyId"
                        [value]="item.amount * item.exchangeRate"></tui-money>
                      <span>)</span>
                    </ng-container>
                  </td>

                  <td *tuiCell="'actions'" tuiTd class="column-actions">
                    <button
                      tuiIconButton
                      appearance="flat"
                      size="s"
                      icon="fa::pen"
                      title="Edit"
                      shape="rounded"
                      class="mr-1"
                      (click)="edit$.next(item.id)"></button>

                    <button
                      tuiIconButton
                      appearance="flat-destructive"
                      size="s"
                      icon="tuiIconTrash"
                      title="Remove"
                      appRequireConfirmation
                      (confirm)="delete$.next(item.id)"
                      confirmationMessage="Are you sure you want to delete this transaction? This action is irreversible."
                      shape="rounded"></button>
                  </td>
                </tr>
              </tbody>

              <tfoot *tuiLet="(data.apiLoading$ | async)! as apiLoading">
                <tr *ngIf="apiLoading || items === null">
                  <td [colSpan]="5" class="py-4">
                    <tui-loader></tui-loader>
                  </td>
                </tr>

                <tr *ngIf="items && items.length === 0 && !apiLoading">
                  <td [colSpan]="5" class="py-4 text-3 text-center">
                    No records found
                  </td>
                </tr>
              </tfoot>
            </table>
          </cdk-virtual-scroll-viewport>
        </tui-scrollbar>
      </div>
    </main>
  </ng-container>

  <ng-template #categoriesDropdown>
    <app-searchable-list
      [getListFunction]="dataApis.getCategories"
      [control]="filters.controls.categories">
    </app-searchable-list>
  </ng-template>
  <ng-template #labelsDropdown>
    <app-searchable-list
      [getListFunction]="dataApis.getLabels"
      [control]="filters.controls.labels">
    </app-searchable-list>
  </ng-template>
  <ng-template #recipientsDropdown>
    <app-searchable-list
      [getListFunction]="dataApis.getRecipients"
      [control]="filters.controls.recipients">
    </app-searchable-list>
  </ng-template>
</ng-container>
